name: LA28 Signup

on:
  repository_dispatch:
    types: [run-bot]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  signup:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          python -m seleniumbase install chromedriver latest || true

      - name: Decode data.csv
        run: |
          echo "${{ secrets.DATA_CSV_B64 }}" | base64 -d > data.csv

      - name: Claim next row atomically
        id: claim
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python - <<'PY'
          import csv
          import os
          import time
          import requests

          api = "https://api.github.com"
          token = os.environ["GH_TOKEN"]
          repo = os.environ["REPO"]
          headers = {
              "Accept": "application/vnd.github+json",
              "Authorization": f"token {token}",
              "X-GitHub-Api-Version": "2022-11-28",
          }

          with open("data.csv", newline="") as f:
              reader = csv.reader(f)
              next(reader, None)
              total = sum(1 for row in reader if any(cell.strip() for cell in row))

          def get_next_row():
              r = requests.get(f"{api}/repos/{repo}/actions/variables/NEXT_ROW", headers=headers)
              if r.status_code == 404:
                  requests.post(
                      f"{api}/repos/{repo}/actions/variables",
                      headers=headers,
                      json={"name": "NEXT_ROW", "value": "0"},
                  )
                  return 0
              return int(r.json()["value"])

          def set_next_row(val):
              r = requests.patch(
                  f"{api}/repos/{repo}/actions/variables/NEXT_ROW",
                  headers=headers,
                  json={"name": "NEXT_ROW", "value": str(val)},
              )
              return r.status_code == 204

          max_retries = 10
          claimed = None
          for attempt in range(max_retries):
              current = get_next_row()
              if current >= total:
                  break

              target = current + 1
              if set_next_row(target):
                  time.sleep(0.3)
                  verify = get_next_row()
                  if verify >= target:
                      claimed = current
                      break
              time.sleep(0.5 * (attempt + 1))

          output_path = os.environ["GITHUB_OUTPUT"]
          with open(output_path, "a") as f:
              if claimed is not None:
                  f.write("has_row=true\n")
                  f.write(f"row_to_process={claimed}\n")
                  f.write(f"total_rows={total}\n")
                  print(f"Claimed row {claimed} of {total}")
              else:
                  f.write("has_row=false\n")
                  print(f"No rows available (total={total})")
          PY

      - name: Run single signup
        if: steps.claim.outputs.has_row == 'true'
        env:
          CI: "true"
          HEADLESS: "1"
          IMAP_USER: ${{ secrets.IMAP_USER }}
          IMAP_PASS: ${{ secrets.IMAP_PASS }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python bot.py --row-index "${{ steps.claim.outputs.row_to_process }}"
